<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script type="text/javascript" src="/eel.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.2);
            --glass-border: rgba(255, 255, 255, 0.25);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --text-primary: #f0f0f0;
            --text-secondary: #d1d1d1;
            --text-muted: #a0a0a0;
            --border-radius: 16px;
            --border-radius-sm: 12px;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-primary);
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--glass-shadow);
        }

        .container-fluid {
            padding: 1.5rem;
            max-width: 1800px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fdfbfb, #ebedee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-control,
        .input-group-text {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            border-radius: var(--border-radius-sm);
        }

        .form-control:focus {
            background: rgba(0, 0, 0, 0.3);
            border-color: #a3bffa;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            color: white;
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            transition: all 0.3s ease;
        }

        .results-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        #interactive-graph {
            height: 100%;
        }

        #graph-container {
            flex: 3;
            min-height: 0;
        }

        #source-code-container {
            flex: 1;
            min-height: 0;
        }

        .source-code-display {
            background: #282c34;
            color: #f8f8f2;
            font-family: 'SF Mono', Monaco, Consolas, 'Courier New', monospace;
            height: 100%;
            overflow-y: auto;
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Global Header -->
        <header class="header">
            <h1>
                <img src="img/logo.png" alt="Logo" style="height: 7rem; vertical-align: middle; margin-right: 0.5rem;">
                AI Code Visualizer
            </h1>
        </header>

        <!-- Main Content Area -->
        <div class="row gx-4 flex-grow-1" style="min-height: 0;">
            <!-- Left Panel: Configuration -->
            <div class="col-lg-3 d-flex flex-column h-100">
                <div class="glass-card p-4 h-100 d-flex flex-column">
                    <form id="analysis-form" class="d-flex flex-column h-100">
                        <div class="flex-grow-1">
                            <!-- Project Settings -->
                            <div class="mb-3">
                                <label for="project-dir" class="form-label fw-bold"><i class="fas fa-folder-open"></i>
                                    Project Directory</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="project-dir"
                                        placeholder="Select your project folder" required readonly>
                                    <button type="button" class="btn btn-secondary" onclick="browseFolder()"><i
                                            class="fas fa-search"></i> Browse</button>
                                </div>
                            </div>
                            <!-- Entry Point -->
                            <div class="mb-3">
                                <label for="entry-file" class="form-label fw-bold"><i class="fas fa-file-code"></i>
                                    Entry File</label>
                                <input type="text" class="form-control" id="entry-file" placeholder="e.g., main.py"
                                    required>
                            </div>
                            <div class="mb-3">
                                <label for="entry-func" class="form-label fw-bold"><i class="fas fa-play"></i> Entry
                                    Function <small>(Optional)</small></label>
                                <input type="text" class="form-control" id="entry-func" placeholder="e.g., main">
                                <div class="form-text text-white-50">Leave blank to trace all functions in the entry
                                    file.</div>
                            </div>
                            <!-- AI Settings -->
                            <div class="mb-4">
                                <label for="api-key" class="form-label fw-bold"><i class="fas fa-key"></i> Gemini API
                                    Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="api-key"
                                        placeholder="For AI summaries">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="toggleApiKeyVisibility()"><i class="fas fa-eye"
                                            id="apiKeyToggle"></i></button>
                                </div>
                            </div>
                        </div>
                        <!-- Action Button (at the bottom) -->
                        <div class="d-grid mt-auto">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="fas fa-rocket"></i> Generate Visualization
                                <span class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Panel: Visualization -->
            <div class="col-lg-9 d-flex flex-column h-100">
                <div id="welcome-screen" class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center">
                        <h2 class="display-4 text-white">Welcome!</h2>
                        <p class="lead text-white-50">Configure your project on the left and click "Generate" to start.
                        </p>
                    </div>
                </div>

                <!-- Results container now uses a vertical flex layout -->
                <div id="results" class="results-container h-100 d-none">
                    <!-- Graph Container -->
                    <div id="graph-container" class="glass-card d-flex flex-column">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-sitemap"></i> Interactive Call Graph</span>
                            <div>
                                <button class="btn btn-sm btn-secondary" onclick="fitGraph()" title="Fit"><i
                                        class="fas fa-expand-arrows-alt"></i></button>
                                <button class="btn btn-sm btn-secondary ms-2" onclick="togglePhysics()"
                                    title="Physics"><i class="fas fa-atom"></i></button>
                            </div>
                        </div>
                        <div id="interactive-graph" class="flex-grow-1"></div>
                    </div>
                    <!-- Source Code Container -->
                    <div id="source-code-container" class="glass-card d-flex flex-column">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-code"></i> Source Code</span>
                            <button class="btn btn-sm btn-secondary" onclick="copyCode(this)" title="Copy"><i
                                    class="fas fa-copy"></i></button>
                        </div>
                        <div class="source-code-display flex-grow-1">
                            <div id="source-code-content" class="p-3">
                                <div class="text-center p-4 text-muted">
                                    <i class="fas fa-mouse-pointer fs-2 mb-3"></i>
                                    <p>Click a node to view its code.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="text-center text-white">
            <div class="spinner mx-auto mb-4"></div>
            <h4 class="fs-4" id="loadingMessage">Analyzing...</h4>
        </div>
    </div>

    <script>
        let currentNetwork = null;

        eel.expose(update_loading_message);
        function update_loading_message(message) {
            document.getElementById('loadingMessage').textContent = message;
        }

        async function browseFolder() {
            const folderPath = await eel.browse_for_folder()();
            if (folderPath) {
                document.getElementById('project-dir').value = folderPath;
            }
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('api-key');
            const icon = document.getElementById('apiKeyToggle');
            input.type = input.type === 'password' ? 'text' : 'password';
            icon.className = `fas fa-eye${input.type === 'password' ? '' : '-slash'}`;
        }

        document.getElementById('analysis-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            const spinner = submitBtn.querySelector('.spinner-border');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const welcomeScreen = document.getElementById('welcome-screen');
            const resultsContainer = document.getElementById('results');

            const projectDir = document.getElementById('project-dir').value;
            const entryFile = document.getElementById('entry-file').value;
            const entryFunc = document.getElementById('entry-func').value;
            const apiKey = document.getElementById('api-key').value;

            // --- LOGIC FIX STARTS HERE ---
            submitBtn.disabled = true;
            spinner.style.display = 'inline-block'; // Keep this for the button spinner
            loadingOverlay.classList.remove('d-none'); // Show loading overlay
            welcomeScreen.classList.add('d-none'); // Hide welcome screen
            resultsContainer.classList.add('d-none'); // Hide previous results

            const result = await eel.analyze_project_and_visualize(projectDir, entryFile, entryFunc, apiKey)();

            loadingOverlay.classList.add('d-none'); // Hide loading overlay
            submitBtn.disabled = false;
            spinner.style.display = 'none';

            if (result.status === 'success') {
                resultsContainer.classList.remove('d-none'); // Show results
                resultsContainer.classList.add('d-flex'); // Ensure it's a flex container
                drawInteractiveGraph(result.diagramData);
                console.log("Analysis Logs:\n", result.logs);
            } else {
                alert(`Error: ${result.message}`);
                welcomeScreen.classList.remove('d-none'); // Show welcome screen again on error
            }
            // --- LOGIC FIX ENDS HERE ---
        });

        function drawInteractiveGraph(data) {
            const container = document.getElementById('interactive-graph');
            const options = {
                layout: { hierarchical: { direction: 'UD', sortMethod: 'directed', levelSeparation: 150 } },
                nodes: {
                    shape: 'box', font: { size: 14, face: 'Inter', color: '#f0f0f0' },
                    borderWidth: 2, shapeProperties: { borderRadius: 8 }, margin: 15,
                    color: { border: 'rgba(255,255,255,0.5)', background: 'rgba(0,0,0,0.3)' }
                },
                edges: {
                    arrows: { to: { enabled: true } }, color: { color: 'rgba(255,255,255,0.4)' },
                    width: 2, smooth: { type: 'cubicBezier', roundness: 0.7 }
                },
                physics: { enabled: true, solver: 'hierarchicalRepulsion', hierarchicalRepulsion: { nodeDistance: 150 } },
                interaction: { hover: true, tooltipDelay: 200 }
            };
            currentNetwork = new vis.Network(container, data, options);
            currentNetwork.on("click", params => {
                if (params.nodes.length > 0) {
                    const node = data.nodes.find(n => n.id === params.nodes[0]);
                    if (node?.source_code) displaySourceCode(node.source_code);
                }
            });
        }

        function displaySourceCode(sourceCode) {
            const display = document.getElementById('source-code-content');
            const highlightedCode = hljs.highlight(sourceCode, { language: 'python' }).value;
            display.innerHTML = `<pre><code class="python hljs">${highlightedCode}</code></pre>`;
        }

        function fitGraph() { if (currentNetwork) currentNetwork.fit(); }
        function togglePhysics() { if (currentNetwork) currentNetwork.setOptions({ physics: { enabled: !currentNetwork.physics.options.enabled } }); }
        function copyCode(button) {
            const codeDisplay = document.getElementById('source-code-content');
            const textArea = document.createElement("textarea");
            textArea.value = codeDisplay.innerText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const icon = button.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'fas fa-check';
                setTimeout(() => { icon.className = originalClass; }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
            document.body.removeChild(textArea);
        }
    </script>
</body>

</html>